---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// Fetch page metadata
const siteEntries = await getCollection('site');
const pageMetaEntry = siteEntries.find(entry => entry.data.type === 'page-meta' && entry.id === 'about-page');
const pageMeta = pageMetaEntry?.data;

// Fetch bio paragraphs and pre-render content
const allBio = await getCollection('bio');
const bioEntriesSorted = allBio
  .filter(entry => entry.data.section === 'about-main')
  .sort((a, b) => a.data.order - b.data.order);

const bioEntries = await Promise.all(
  bioEntriesSorted.map(async (entry) => ({
    ...entry,
    Content: (await render(entry)).Content,
  }))
);

// Fetch expertise cards for about page and pre-render content
const allExpertise = await getCollection('expertise');
const aboutExpertiseSorted = allExpertise
  .filter(entry => entry.data.pages.includes('about'))
  .sort((a, b) => a.data.order - b.data.order);

const aboutExpertise = await Promise.all(
  aboutExpertiseSorted.map(async (entry) => ({
    ...entry,
    Content: (await render(entry)).Content,
  }))
);

// Fetch timeline entries and pre-render content
const allTimeline = await getCollection('timeline');
const timelineEntriesSorted = allTimeline.sort((a, b) => a.data.order - b.data.order);

const timelineEntries = await Promise.all(
  timelineEntriesSorted.map(async (entry) => ({
    ...entry,
    Content: (await render(entry)).Content,
  }))
);
---

<BaseLayout
  title="About - Bradley Fay"
  description="Product leader specializing in experimentation platforms, ML/AI strategy, and data science team development. VP-level expertise in building high-impact systems from the ground up."
>
  <div class="about-page">
    <!-- Hero Section -->
    <section class="hero">
      <div class="container">
        <h1>{pageMeta?.title || 'About'}</h1>
        <p class="lead">
          {pageMeta?.lead || 'Product leader at the intersection of data science, machine learning, and experimentation. I architect structure from chaos and build high-performing teams that deliver measurable business impact.'}
        </p>
      </div>
    </section>

    <!-- Bio Section -->
    <section class="bio">
      <div class="container">
        <h2>Background</h2>
        <div class="bio-content">
          {bioEntries.map(({ Content }) => <Content />)}
        </div>
      </div>
    </section>

    <!-- Expertise Section -->
    <section class="expertise">
      <div class="container">
        <h2>Areas of Expertise</h2>
        <div class="expertise-grid">
          {aboutExpertise.map(({ data, Content }) => (
            <div class="expertise-card">
              <h3>{data.title}</h3>
              <Content />
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- Career Highlights Section -->
    <section class="highlights">
      <div class="container">
        <h2>Career Highlights</h2>
        <div class="timeline">
          {timelineEntries.map(({ data, Content }) => (
            <div class="timeline-item">
              <div class="timeline-year">{data.year}</div>
              <div class="timeline-content">
                <h3>{data.title}</h3>
                <Content />
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .about-page {
    padding-bottom: var(--space-2xl);
  }

  /* Hero Section */
  .hero {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--color-border);
  }

  .hero h1 {
    margin-bottom: var(--space-md);
  }

  .lead {
    font-size: var(--text-lg);
    line-height: 1.7;
    color: var(--color-text-muted);
    max-width: 48rem;
  }

  /* Bio Section */
  .bio {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-2xl);
  }

  .bio-content {
    max-width: 48rem;
  }

  .bio-content p {
    font-size: var(--text-lg);
    line-height: 1.7;
    margin-bottom: var(--space-lg);
  }

  .bio-content p:last-child {
    margin-bottom: 0;
  }

  /* Expertise Section */
  .expertise {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-2xl);
    background-color: var(--color-surface);
  }

  .expertise h2 {
    margin-bottom: var(--space-xl);
  }

  .expertise-grid {
    display: grid;
    gap: var(--space-lg);
    grid-template-columns: 1fr;
  }

  @media (min-width: 640px) {
    .expertise-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .expertise-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-xl);
    }
  }

  .expertise-card {
    background: var(--color-background);
    padding: var(--space-lg);
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
  }

  .expertise-card h3 {
    font-size: var(--text-xl);
    margin-bottom: var(--space-md);
    color: var(--color-text);
  }

  .expertise-card p {
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--color-text-muted);
    margin-bottom: 0;
  }

  /* Career Highlights Section */
  .highlights {
    padding-top: var(--space-2xl);
    padding-bottom: var(--space-2xl);
  }

  .highlights h2 {
    margin-bottom: var(--space-xl);
  }

  .timeline {
    max-width: 48rem;
    position: relative;
    padding-left: 0;
  }

  /* Timeline connector line - positioned relative to year column */
  @media (min-width: 640px) {
    .timeline::before {
      content: '';
      position: absolute;
      left: 6.5rem;
      top: 0.35rem;
      bottom: 1rem;
      width: 2px;
      background: linear-gradient(to bottom, var(--color-accent), var(--color-border));
    }
  }

  .timeline-item {
    display: grid;
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
    grid-template-columns: 1fr;
    position: relative;
  }

  @media (min-width: 640px) {
    .timeline-item {
      grid-template-columns: 6rem 1fr;
      gap: var(--space-xl);
      align-items: start;
      padding-left: 0;
    }
  }

  .timeline-item:last-child {
    margin-bottom: 0;
  }

  .timeline-year {
    font-family: var(--font-serif);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-accent);
    position: relative;
    white-space: nowrap;
    text-align: right;
    padding-right: var(--space-lg);
  }

  @media (min-width: 640px) {
    .timeline-year::after {
      content: '';
      position: absolute;
      right: -0.25rem;
      top: 0.25rem;
      width: 0.5rem;
      height: 0.5rem;
      background: var(--color-accent);
      border-radius: 50%;
    }
  }

  .timeline-content h3 {
    font-size: var(--text-xl);
    margin-bottom: var(--space-sm);
  }

  .timeline-content p {
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--color-text-muted);
    margin-bottom: 0;
  }

  /* Responsive adjustments */
  @media (min-width: 1024px) {
    .hero {
      padding-top: var(--space-2xl);
      padding-bottom: var(--space-2xl);
    }

    .lead {
      font-size: var(--text-xl);
    }

    .bio-content p {
      font-size: var(--text-lg);
    }
  }
</style>
